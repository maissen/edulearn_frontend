<!-- üåê Navbar -->
<app-navbar></app-navbar>

<!-- Contenu principal -->
<div class="course-detail-page">

  <!-- Two-column layout -->
  <div class="two-column-layout">
    <!-- Left Column: Course Info, Description, and Test -->
    <div class="left-column">
      <header class="course-header">
        <h1>{{ course?.title }}</h1>
        <p class="course-subtitle">{{ course?.subtitle }}</p>
        <div class="course-meta">
          <span>‚≠ê {{ instructor.rating }}/5</span>
        </div>
        <!-- Update Course Button for Teachers -->
        @if (isTeacher) {
          <div class="teacher-actions">
            <button type="button" class="btn-update-course" (click)="updateCourse()">
              <i class="icon-edit"></i> Update Course
            </button>
          </div>
        }
      </header>

      <!-- Course Description -->
      <section class="course-description-section">
        <h2>üìñ Course Description</h2>
        <p *ngIf="hasDescription; else noDescription">
          {{ course?.description }}
        </p>
        <ng-template #noDescription>
          <p class="no-description">No description available for this course.</p>
        </ng-template>
      </section>

      <!-- Show congratulatory message if student passed the test -->
      @if (hasTakenTest && studentScore !== null && studentScore >= 12 && !isTeacher) {
        <div class="test-result" style="margin-top: 1rem; margin-bottom: 1rem;">
          <div class="celebration-complete" style="position: static; transform: none; padding: 1.5rem; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); z-index: auto;">
            <h2>üéâ Congratulations!</h2>
            <p>You've successfully passed the exam with a score of {{ studentScore }}/{{ totalScore }}.</p>
            @if (!isCourseCompleted) {
              <p>Complete this course to add it to your achievements.</p>
              <button type="button" class="btn-finish-course" (click)="completeCourse()">
                Finish this Course
              </button>
            } @else {
              <p>This course has been completed! üéì</p>
              <button type="button" class="btn-finish-course" disabled>
                Course Completed
              </button>
            }
          </div>
        </div>
      }
      
      <!-- Show encouraging message if student failed the test -->
      @if (hasTakenTest && studentScore !== null && studentScore < 12 && !isTeacher) {
        <div class="test-result" style="margin-top: 1rem; margin-bottom: 1rem;">
          <div class="encouragement-message" style="position: static; transform: none; padding: 1.5rem; background: linear-gradient(135deg, #fffbeb, #fef3c7); border-radius: 12px; text-align: center; border: 1px solid #fde68a; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); z-index: auto;">
            <h2>üìö Keep Trying!</h2>
            <p>You scored {{ studentScore }}/{{ totalScore }}.</p>
          </div>
        </div>
      }

      <!-- Quiz Section -->
      <section class="quiz-section">
        @if (isTeacher) {
          <!-- Teacher view: Display test information with questions and correct answers -->
          @if (course && course.test) {
            <div class="test-display">
              <h2>üìù {{ course.test.titre }}</h2>
              <div class="questions-list">
                <div class="question-card" *ngFor="let question of course.test.questions; let i = index">
                  <div class="question-header">
                    <h3 class="question-number">Question {{ i + 1 }}</h3>
                    <h4 class="question-text">{{ question.question }}</h4>
                  </div>
                  <div class="options-container">
                    <div class="option-item">
                      <span class="option-label">A.</span>
                      <span class="option-text">{{ question.options.a }}</span>
                    </div>
                    <div class="option-item">
                      <span class="option-label">B.</span>
                      <span class="option-text">{{ question.options.b }}</span>
                    </div>
                    <div class="option-item">
                      <span class="option-label">C.</span>
                      <span class="option-text">{{ question.options.c }}</span>
                    </div>
                    <div class="option-item">
                      <span class="option-label">D.</span>
                      <span class="option-text">{{ question.options.d }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          } @else {
            <!-- No test created yet -->
            <div class="quiz-header">
              <h2>üß† Pass your exam Now</h2>
              <button type="button" class="btn-add-quiz" (click)="openAddQuizModal()">
                <i class="icon-plus"></i> Add Quiz
              </button>
            </div>
            <div class="empty-quiz">
              <div class="empty-icon">üß†</div>
              <h3>No test created yet</h3>
              <p>Create a test for your students to evaluate their knowledge.</p>
              <button type="button" class="btn-add-first-quiz" (click)="openAddQuizModal()">
                Create Test
              </button>
            </div>
          }
        } @else {
          <!-- Student view: Quiz taking -->
          <div class="quiz-header">
            <h2>üß† Pass your exam Now</h2>
          </div>
          
          @if (quizzes.length === 0) {
            <div class="empty-quiz">
              <div class="empty-icon">üß†</div>
              <h3>No quizzes yet</h3>
              <p>Quizzes will help you test your knowledge and understanding.</p>
            </div>
          } @else {
            <div class="student-quiz-section">
              <div class="quiz-info">
                <div class="quiz-stats">
                  <div class="stat-item">
                    <span class="stat-number">{{ quizzes.length }}</span>
                    <span class="stat-label">Test{{ quizzes.length > 1 ? 's' : '' }} Available</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-number">{{ getTotalQuestions() }}</span>
                    <span class="stat-label">Questions Total</span>
                  </div>
                </div>
                
                <!-- Show test result if student has taken the test -->
                @if (hasTakenTest) {
                  <div class="test-result">
                    <div class="result-score">
                      <span class="score">{{ studentScore }} / {{ totalScore }}</span>
                      <span class="status" [class.passed]="studentScore && studentScore >= 12" [class.failed]="studentScore && studentScore <= 12">
                        {{ studentScore && studentScore >= 12 ? 'Passed' : 'Failed' }}
                      </span>
                    </div>
                  </div>
                }
                
                <!-- Show the Start Test button for students who haven't taken the test or failed the test -->
                @if (!hasTakenTest || (hasTakenTest && (studentScore === null || studentScore === undefined || studentScore < 12))) {
                  <div class="quiz-actions">
                    <button type="button" class="btn-start-quiz" (click)="startQuiz()" [disabled]="(hasTakenTest && studentScore !== null && studentScore !== undefined && studentScore >= 12) || !hasStartedCourse || !isEnrolled">
                      üöÄ Start Test Now
                    </button>
                  </div>
                  <!-- Notice for students who haven't started the course -->
                  <div *ngIf="!hasStartedCourse" class="start-course-notice" style="width: 100%; text-align: center; color: #e74c3c; font-style: italic; margin-top: 1rem; padding: 0.5rem; border-top: 1px solid #e2e8f0;">
                    You need to start the course before taking the test.
                  </div>
                }
              </div>
            </div>
          }
        }
      </section>
    </div>

    <!-- Right Column: Video/Start Course Button -->
    <div class="right-column">
      <div class="video-player">
        <!-- Show start course button for students who are not enrolled and haven't finished the course -->
        <div *ngIf="!isTeacher && showStartCourseButton && !isCourseCompleted && !loading" class="start-course-container">
          <button type="button" class="btn-start-course" (click)="startCourse()">
            üöÄ Start the Course Now
          </button>
        </div>
        
        <!-- Show video player for teachers, enrolled students, or students who have finished the course -->
        <div *ngIf="isTeacher || !showStartCourseButton || isCourseCompleted">
          <iframe 
            [src]="safeVideoUrl"
            frameborder="0" 
            allowfullscreen
            width="100%" 
            height="500px">
          </iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Modal (Teacher) -->
  @if (showQuizModal) {
    <div class="modal-overlay" (click)="closeQuizModal()">
      <div class="modal-content quiz-creation-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editingQuizIndex !== null ? 'Edit Test' : 'Create Course Test' }}</h3>
          <button type="button" class="modal-close" (click)="closeQuizModal()">
            <i class="icon-close"></i>
          </button>
        </div>

        <form (ngSubmit)="saveQuiz()" class="quiz-form">
          <!-- Test Title -->
          <div class="form-group">
            <label for="testTitle">Test Title *</label>
            <input type="text" id="testTitle" [(ngModel)]="currentTest.title"
                   name="title" placeholder="e.g., Python Fundamentals Test" required>
          </div>

          <!-- Questions Section -->
          <div class="questions-section">
            <div class="section-header">
              <label>Questions</label>
              <button type="button" class="btn-add-question" (click)="addQuestion()">
                <i class="icon-plus"></i> Add Question
              </button>
            </div>

            <div class="questions-list">
              <div class="question-item" *ngFor="let question of currentTest.questions; let i = index">
                <div class="question-header">
                  <span class="question-number">Question {{ i + 1 }}</span>
                  <button type="button" class="btn-remove-question"
                          (click)="removeQuestion(i)"
                          [disabled]="currentTest.questions.length <= 1">
                    <i class="icon-trash"></i>
                  </button>
                </div>

                <div class="question-content">
                  <!-- Question Text -->
                  <div class="form-group">
                    <input type="text" [(ngModel)]="currentTest.questions[i].question"
                           [name]="'question_' + i"
                           placeholder="Enter your question" required>
                  </div>

                  <!-- Options -->
                  <div class="options-grid">
                    <div class="option-group">
                      <div class="option-input-group">
                        <label class="option-label">A.</label>
                        <input type="text" [(ngModel)]="currentTest.questions[i].option_a"
                               [name]="'option_' + i + '_a'"
                               placeholder="Option A"
                               required>
                      </div>
                    </div>
                    <div class="option-group">
                      <div class="option-input-group">
                        <label class="option-label">B.</label>
                        <input type="text" [(ngModel)]="currentTest.questions[i].option_b"
                               [name]="'option_' + i + '_b'"
                               placeholder="Option B"
                               required>
                      </div>
                    </div>
                    <div class="option-group">
                      <div class="option-input-group">
                        <label class="option-label">C.</label>
                        <input type="text" [(ngModel)]="currentTest.questions[i].option_c"
                               [name]="'option_' + i + '_c'"
                               placeholder="Option C"
                               required>
                      </div>
                    </div>
                    <div class="option-group">
                      <div class="option-input-group">
                        <label class="option-label">D.</label>
                        <input type="text" [(ngModel)]="currentTest.questions[i].option_d"
                               [name]="'option_' + i + '_d'"
                               placeholder="Option D"
                               required>
                      </div>
                    </div>
                  </div>

                  <!-- Correct Answer -->
                  <div class="correct-answer-group">
                    <label>Correct Answer:</label>
                    <select [(ngModel)]="currentTest.questions[i].correct"
                            [name]="'correct_' + i" required>
                      <option [value]="'a'">A. {{ currentTest.questions[i].option_a || 'Option A' }}</option>
                      <option [value]="'b'">B. {{ currentTest.questions[i].option_b || 'Option B' }}</option>
                      <option [value]="'c'">C. {{ currentTest.questions[i].option_c || 'Option C' }}</option>
                      <option [value]="'d'">D. {{ currentTest.questions[i].option_d || 'Option D' }}</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeQuizModal()">Cancel</button>
            <button type="submit" class="btn-primary" [disabled]="!isTestFormValid()">
              {{ editingQuizIndex !== null ? 'Update Test' : 'Create Test' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Quiz Taking Modal (Student) -->
  @if (showQuizTakingModal) {
    <div class="modal-overlay" (click)="closeQuizTakingModal()">
      <div class="modal-content quiz-taking-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üß† Course Quiz</h3>
          <button type="button" class="modal-close" (click)="closeQuizTakingModal()">
            <i class="icon-close"></i>
          </button>
        </div>

        <div class="quiz-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="((currentQuestionIndex + 1) / quizQuestions.length) * 100"></div>
          </div>
          <span class="progress-text">Question {{ currentQuestionIndex + 1 }} of {{ quizQuestions.length }}</span>
        </div>

        @if (!quizSubmissionResult) {
          <!-- Quiz Questions -->
          <div class="quiz-question-section">
            @if (getCurrentQuestion()) {
              <div class="question-card">
                <h4 class="question-text">{{ getCurrentQuestion().question }}</h4>
                <div class="options-list">
                  <div class="option-item"
                       *ngFor="let option of getCurrentQuestion().options"
                       [class.selected]="selectedAnswers[getCurrentQuestion().id] === option.value"
                       (click)="selectAnswer(getCurrentQuestion().id, option.value)">
                    <div class="option-radio">
                      <div class="radio-circle" [class.checked]="selectedAnswers[getCurrentQuestion().id] === option.value"></div>
                    </div>
                    <div class="option-content">
                      <span class="option-key">{{ option.key | uppercase }}.</span>
                      <span class="option-text">{{ option.text }}</span>
                    </div>
                  </div>
                </div>
              </div>
            }

            <div class="quiz-navigation">
              <button type="button"
                      class="btn-secondary"
                      [disabled]="currentQuestionIndex === 0"
                      (click)="previousQuestion()">
                ‚Üê Previous
              </button>
              <button type="button"
                      class="btn-primary"
                      [disabled]="!canProceed()"
                      (click)="nextQuestion()">
                {{ isLastQuestion() ? 'Check Your Score' : 'Next' }}
              </button>
            </div>
          </div>
        } @else {
          <!-- Quiz Results -->
          <div class="quiz-results">
            <div class="results-header">
              <div class="score-circle">
                <span class="score-number">{{ quizSubmissionResult.score }}/20</span>
                <span class="score-label">Your Score</span>
              </div>
            </div>

            <div class="results-details">
              <div class="result-stat">
                <span class="stat-value">{{ quizSubmissionResult.correctAnswers }}</span>
                <span class="stat-label">Correct Answers</span>
              </div>
              <div class="result-stat">
                <span class="stat-value">{{ quizSubmissionResult.totalQuestions }}</span>
                <span class="stat-label">Total Questions</span>
              </div>
              <div class="result-stat">
                <span class="stat-value">{{ quizSubmissionResult.pointsPerQuestion }}</span>
                <span class="stat-label">Points per Question</span>
              </div>
            </div>

            <div class="results-message">
              @if (quizSubmissionResult.score >= 16) {
                <div class="success-message">
                  üéâ Excellent! You've mastered this material!
                </div>
              } @else if (quizSubmissionResult.score >= 12) {
                <div class="good-message">
                  üëç Good job! Keep practicing to improve further.
                </div>
              } @else {
                <div class="retry-message">
                  üìö Don't worry! Review the material and try again.
                </div>
              }
            </div>

            <div class="results-actions">
              <button type="button" class="btn-secondary" (click)="closeQuizTakingModal()">
                Close
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>

<app-footer></app-footer>