<!-- üåê Navbar -->
<app-navbar></app-navbar>

<!-- Contenu principal -->
<div class="course-detail-page">

  <!-- En-t√™te vid√©o -->
  <header class="course-header">
    <h1>{{ course?.title }}</h1>
    <p class="course-subtitle">{{ course?.subtitle }}</p>
    <div class="course-meta">
      <span>‚è±Ô∏è {{ course?.duration }}</span>
      <span>‚≠ê {{ instructor.rating }}/5</span>
    </div>
  </header>

  <!-- Player vid√©o -->
  <div class="video-player">
    <iframe 
  [src]="safeVideoUrl"
  frameborder="0" 
  allowfullscreen
  width="100%" 
  height="400px">
</iframe>
  </div>

  <!-- Description & sections -->
  <div class="course-content">

  <!-- Course Description -->
  <section class="course-description-section">
    <h2>üìñ Course Description</h2>
    <p *ngIf="hasDescription; else noDescription">
      {{ course?.description }}
    </p>
    <ng-template #noDescription>
      <p class="no-description">No description available for this course.</p>
    </ng-template>
  </section>

  <!-- Quiz Section -->
  <section class="quiz-section">
    <div class="quiz-header">
      <h2>üß† Practice Quizzes</h2>
      @if (isTeacher) {
        <button type="button" class="btn-add-quiz" (click)="openAddQuizModal()">
          <i class="icon-plus"></i> Add Quiz
        </button>
      }
    </div>

    @if (quizzes.length === 0) {
      <div class="empty-quiz">
        <div class="empty-icon">üß†</div>
        <h3>No quizzes yet</h3>
        <p>Quizzes will help students test their knowledge and understanding.</p>
        @if (isTeacher) {
          <button type="button" class="btn-add-first-quiz" (click)="openAddQuizModal()">
            Create First Quiz
          </button>
        }
      </div>
    } @else if (isTeacher) {
      <!-- Teacher view: Quiz management -->
      <div class="quiz-gallery">
        <div class="quiz-card" *ngFor="let quiz of quizzes; let i = index">
          <div class="quiz-card-header">
            <div class="quiz-number">Quiz {{ i + 1 }}</div>
            <div class="quiz-actions">
              <button class="btn-edit-quiz" (click)="editQuiz(i)" title="Edit quiz">
                <i class="icon-edit"></i>
              </button>
              <button class="btn-delete-quiz" (click)="deleteQuiz(i)" title="Delete quiz">
                <i class="icon-trash"></i>
              </button>
            </div>
          </div>
          <div class="quiz-card-content">
            <h3 class="quiz-question">{{ quiz.question }}</h3>
            <div class="quiz-options">
              <div class="option" *ngFor="let option of quiz.options; let j = index"
                   [class.correct]="j === quiz.correctAnswer">
                <span class="option-label">{{ j + 1 }}.</span>
                <span class="option-text">{{ option }}</span>
                @if (j === quiz.correctAnswer) {
                  <span class="correct-badge">‚úì Correct</span>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <!-- Student view: Quiz taking -->
      <div class="student-quiz-section">
        <div class="quiz-info">
          <div class="quiz-stats">
            <div class="stat-item">
              <span class="stat-number">{{ quizzes.length }}</span>
              <span class="stat-label">Quiz{{ quizzes.length > 1 ? 'zes' : '' }} Available</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">{{ getTotalQuestions() }}</span>
              <span class="stat-label">Questions Total</span>
            </div>
          </div>
          <button type="button" class="btn-start-quiz" (click)="startQuiz()">
            üöÄ Start Test Now
          </button>
        </div>
      </div>
    }
  </section>
  </div>

  <!-- Recommandations -->
  <section class="related-section" *ngIf="!isTeacher">
    <h2>üéì Student also bought</h2>
    <div class="related-grid">
      <div class="related-card" *ngFor="let c of relatedCourses">
        <img [src]="c.imageUrl" [alt]="c.titre" class="related-image">
        <div class="related-info">
          <h3>{{ c.titre }}</h3>
          <div class="related-meta">
            <span>‚≠ê {{ c.rating }}/5</span>
            <span>${{ c.price }}</span>
          </div>
          <button class="btn-enroll">Enroll Now</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Quiz Modal (Teacher) -->
  @if (showQuizModal) {
    <div class="modal-overlay" (click)="closeQuizModal()">
      <div class="modal-content quiz-creation-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editingQuizIndex !== null ? 'Edit Test' : 'Create Course Test' }}</h3>
          <button type="button" class="modal-close" (click)="closeQuizModal()">
            <i class="icon-close"></i>
          </button>
        </div>

        <form (ngSubmit)="saveQuiz()" class="quiz-form">
          <!-- Test Title -->
          <div class="form-group">
            <label for="testTitle">Test Title *</label>
            <input type="text" id="testTitle" [(ngModel)]="currentTest.title"
                   name="title" placeholder="e.g., Python Fundamentals Test" required>
          </div>

          <!-- Questions Section -->
          <div class="questions-section">
            <div class="section-header">
              <label>Questions</label>
              <button type="button" class="btn-add-question" (click)="addQuestion()">
                <i class="icon-plus"></i> Add Question
              </button>
            </div>

            <div class="questions-list">
              <div class="question-item" *ngFor="let question of currentTest.questions; let i = index">
                <div class="question-header">
                  <span class="question-number">Question {{ i + 1 }}</span>
                  <button type="button" class="btn-remove-question"
                          (click)="removeQuestion(i)"
                          [disabled]="currentTest.questions.length <= 1">
                    <i class="icon-trash"></i>
                  </button>
                </div>

                <div class="question-content">
                  <!-- Question Text -->
                  <div class="form-group">
                    <input type="text" [(ngModel)]="currentTest.questions[i].question"
                           [name]="'question_' + i"
                           placeholder="Enter your question" required>
                  </div>

                  <!-- Options -->
                  <div class="options-grid">
                    <div class="option-group" *ngFor="let option of ['a', 'b', 'c', 'd']; let j = index">
                      <div class="option-input-group">
                        <label class="option-label">{{ option | uppercase }}.</label>
                        <input type="text" [(ngModel)]="currentTest.questions[i]['option_' + option]"
                               [name]="'option_' + i + '_' + option"
                               [placeholder]="'Option ' + option.toUpperCase()"
                               required>
                      </div>
                    </div>
                  </div>

                  <!-- Correct Answer -->
                  <div class="correct-answer-group">
                    <label>Correct Answer:</label>
                    <select [(ngModel)]="currentTest.questions[i].correct"
                            [name]="'correct_' + i" required>
                      <option [value]="'a'">A. {{ currentTest.questions[i].option_a || 'Option A' }}</option>
                      <option [value]="'b'">B. {{ currentTest.questions[i].option_b || 'Option B' }}</option>
                      <option [value]="'c'">C. {{ currentTest.questions[i].option_c || 'Option C' }}</option>
                      <option [value]="'d'">D. {{ currentTest.questions[i].option_d || 'Option D' }}</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeQuizModal()">Cancel</button>
            <button type="submit" class="btn-primary" [disabled]="!isTestFormValid()">
              {{ editingQuizIndex !== null ? 'Update Test' : 'Create Test' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Quiz Taking Modal (Student) -->
  @if (showQuizTakingModal) {
    <div class="modal-overlay" (click)="closeQuizTakingModal()">
      <div class="modal-content quiz-taking-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üß† Course Quiz</h3>
          <button type="button" class="modal-close" (click)="closeQuizTakingModal()">
            <i class="icon-close"></i>
          </button>
        </div>

        <div class="quiz-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="((currentQuestionIndex + 1) / quizQuestions.length) * 100"></div>
          </div>
          <span class="progress-text">Question {{ currentQuestionIndex + 1 }} of {{ quizQuestions.length }}</span>
        </div>

        @if (!quizSubmissionResult) {
          <!-- Quiz Questions -->
          <div class="quiz-question-section">
            @if (getCurrentQuestion()) {
              <div class="question-card">
                <h4 class="question-text">{{ getCurrentQuestion().question }}</h4>
                <div class="options-list">
                  <div class="option-item"
                       *ngFor="let option of getCurrentQuestion().options"
                       [class.selected]="selectedAnswers[getCurrentQuestion().id] === option.value"
                       (click)="selectAnswer(getCurrentQuestion().id, option.value)">
                    <div class="option-radio">
                      <div class="radio-circle" [class.checked]="selectedAnswers[getCurrentQuestion().id] === option.value"></div>
                    </div>
                    <div class="option-content">
                      <span class="option-key">{{ option.key | uppercase }}.</span>
                      <span class="option-text">{{ option.text }}</span>
                    </div>
                  </div>
                </div>
              </div>
            }

            <div class="quiz-navigation">
              <button type="button"
                      class="btn-secondary"
                      [disabled]="currentQuestionIndex === 0"
                      (click)="previousQuestion()">
                ‚Üê Previous
              </button>
              <button type="button"
                      class="btn-primary"
                      [disabled]="!canProceed()"
                      (click)="nextQuestion()">
                {{ isLastQuestion() ? 'Check Your Score' : 'Next' }}
              </button>
            </div>
          </div>
        } @else {
          <!-- Quiz Results -->
          <div class="quiz-results">
            <div class="results-header">
              <div class="score-circle">
                <span class="score-number">{{ quizSubmissionResult.score }}/20</span>
                <span class="score-label">Your Score</span>
              </div>
            </div>

            <div class="results-details">
              <div class="result-stat">
                <span class="stat-value">{{ quizSubmissionResult.correctAnswers }}</span>
                <span class="stat-label">Correct Answers</span>
              </div>
              <div class="result-stat">
                <span class="stat-value">{{ quizSubmissionResult.totalQuestions }}</span>
                <span class="stat-label">Total Questions</span>
              </div>
              <div class="result-stat">
                <span class="stat-value">{{ quizSubmissionResult.pointsPerQuestion }}</span>
                <span class="stat-label">Points per Question</span>
              </div>
            </div>

            <div class="results-message">
              @if (quizSubmissionResult.score >= 16) {
                <div class="success-message">
                  üéâ Excellent! You've mastered this material!
                </div>
              } @else if (quizSubmissionResult.score >= 12) {
                <div class="good-message">
                  üëç Good job! Keep practicing to improve further.
                </div>
              } @else {
                <div class="retry-message">
                  üìö Don't worry! Review the material and try again.
                </div>
              }
            </div>

            <div class="results-actions">
              <button type="button" class="btn-secondary" (click)="closeQuizTakingModal()">
                Close
              </button>
              <button type="button" class="btn-primary" (click)="startQuiz()">
                Retake Quiz
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  }

</div>

<!-- üèÅ Footer (identique au template) -->
<footer class="footer">
  <div class="footer-logo">
    <app-logo></app-logo>
    <span>EduLearn</span>
  </div>
  <p class="footer-subtitle">Virtual Class for Zoom</p>
  <p>Subscribe to get our Newsletter</p>
  <form class="newsletter-form">
    <input type="email" placeholder="Your Email" class="newsletter-input">
    <button type="submit" class="newsletter-btn">Subscribe</button>
  </form>
  <div class="footer-links">
    <a href="#">Careers</a>
    <a href="#">Privacy Policy</a>
    <a href="#">Terms & Conditions</a>
  </div>
  <p class="footer-copyright">¬© 2025 Class Technologies Inc.</p>
</footer>