<!-- üåê Navbar -->
<app-navbar></app-navbar>

<!-- üìö Contenu principal -->
<div class="manage-courses-page">

  <header class="page-header">
    <div class="header-content">
      <h1>üìö Manage My Courses</h1>
      <p>Create, edit and organize your educational content</p>
    </div>
    <div class="header-stats">
      <div class="stat-item">
        <span class="stat-number">{{ courses.length }}</span>
        <span class="stat-label">Courses</span>
      </div>
    </div>
  </header>

  <!-- Messages -->
  @if (successMessage) {
    <div class="alert alert-success">
      <div class="alert-icon">‚úÖ</div>
      <div class="alert-content">
        <strong>Success!</strong> {{ successMessage }}
      </div>
      <button class="alert-close" (click)="successMessage = ''">&times;</button>
    </div>
  }

  @if (errorMessage) {
    <div class="alert alert-error">
      <div class="alert-icon">‚ùå</div>
      <div class="alert-content">
        <strong>Error:</strong> {{ errorMessage }}
      </div>
      <button class="alert-close" (click)="errorMessage = ''">&times;</button>
    </div>
  }

  <!-- Formulaire -->
  <section class="create-course-form">
    <div class="form-card">
      <div class="form-header">
        <h2>
          @if (mode === 'create') {
            <i class="icon-add"></i> Create New Course
          } @else {
            <i class="icon-edit"></i> Edit Course: {{ oldCourse.title }}
          }
        </h2>
        <div class="form-mode-indicator" [class.mode-create]="mode === 'create'" [class.mode-edit]="mode === 'edit'">
          {{ mode === 'create' ? 'Creating' : 'Editing' }}
        </div>
      </div>

      <form (ngSubmit)="onCreateCourse()" novalidate>
        <!-- Titre -->
        <div class="form-group" [class.error]="formErrors['title']">
          <label for="courseTitle">Course Title *</label>
          <input type="text" id="courseTitle" [(ngModel)]="oldCourse.title" name="title"
                 placeholder="Enter course title" [class.error]="formErrors['title']" required>
          @if (formErrors['title']) {
            <div class="error-message">{{ formErrors['title'] }}</div>
          }
        </div>

        <div class="form-group" [class.error]="formErrors['description']">
          <label for="courseDescription">Description *</label>
          <textarea id="courseDescription" [(ngModel)]="newCourse.description" name="description"
                    rows="4" placeholder="Describe what students will learn in this course"
                    [class.error]="formErrors['description']" required></textarea>
          @if (formErrors['description']) {
            <div class="error-message">{{ formErrors['description'] }}</div>
          }
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="courseCategory">Category</label>
            <select id="courseCategory" [(ngModel)]="oldCourse.category" name="category">
              <option value="">Select category...</option>
              <option value="programming">üíª Programming</option>
              <option value="math">üìê Mathematics</option>
              <option value="design">üé® Design & UX/UI</option>
              <option value="science">üî¨ Sciences</option>
              <option value="business">üíº Business</option>
              <option value="language">üåê Languages</option>
              <option value="other">üìö Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="courseDuration">Duration (hours)</label>
            <input type="number" id="courseDuration" [(ngModel)]="oldCourse.duration"
                   name="duration" min="1" max="100" placeholder="e.g., 10">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="courseImage">Cover Image URL</label>
            <input type="url" id="courseImage" [(ngModel)]="oldCourse.imageUrl" name="imageUrl"
                   placeholder="https://example.com/image.jpg">
            <small>Optional: URL to course thumbnail image</small>
          </div>
          <div class="form-group">
            <label for="courseVideo">Video URL</label>
            <input type="url" id="courseVideo" [(ngModel)]="oldCourse.videoUrl" name="videoUrl"
                   placeholder="https://www.youtube.com/embed/...">
            <small>Optional: YouTube or Vimeo embed URL</small>
          </div>
        </div>

        <!-- Quiz Section -->
        <div class="quiz-section">
          <div class="quiz-header">
            <h3><i class="icon-quiz"></i> Practice Quiz</h3>
            @if (mode === 'create') {
              <button type="button" class="btn-add-quiz" (click)="addQuiz()">
                <i class="icon-plus"></i> Add Quiz
              </button>
            }
          </div>

          <!-- Existing Course Quizzes (when editing) -->
          @if (mode === 'edit') {
            <div class="existing-quizzes">
              <h4>üìö Current Quizzes for this Course</h4>
              @if (courseQuizzes.length === 0) {
                <div class="empty-quizzes">
                  <div class="empty-icon">üß†</div>
                  <p>No quizzes found for this course. Add some quizzes below!</p>
                </div>
              } @else {
                <div class="quiz-list existing">
                  <div class="quiz-item existing" *ngFor="let quiz of courseQuizzes">
                    <div class="quiz-header">
                      <h4>{{ quiz.titre }}</h4>
                      <button type="button" class="btn-delete-quiz"
                              (click)="deleteQuiz(quiz.id!)"
                              title="Delete quiz"
                              [disabled]="loading">
                        <i class="icon-trash"></i> Delete
                      </button>
                    </div>
                    <div class="quiz-meta">
                      <span class="meta-item">Quiz ID: {{ quiz.id }}</span>
                    </div>
                  </div>
                </div>
              }
            </div>
          }

          <!-- New Quizzes (when creating or editing) -->
          @if (mode === 'create' || (mode === 'edit' && oldCourse.quizzes.length > 0)) {
            <div class="new-quizzes">
              @if (mode === 'create') {
                <h4>Add Quizzes to your Course</h4>
              } @else {
                <h4>Add More Quizzes</h4>
              }

              @if (oldCourse.quizzes.length === 0) {
                <div class="empty-quiz">
                  <div class="empty-icon">üß†</div>
                  <p>No quizzes added yet. Add your first quiz to engage students!</p>
                </div>
              } @else {
                <div class="quiz-list">
                  <div class="quiz-item" *ngFor="let quiz of oldCourse.quizzes; let i = index">
                    <div class="quiz-header">
                      <h4>Quiz {{ i + 1 }}</h4>
                      <button type="button" class="btn-remove-quiz" (click)="removeQuiz(i)"
                              title="Remove quiz">
                        <i class="icon-trash"></i>
                      </button>
                    </div>
                    <div class="quiz-body">
                      <div class="form-group">
                        <label>Question</label>
                        <input type="text"
                               [(ngModel)]="oldCourse.quizzes[i].question"
                               [name]="'quiz_' + i + '_question'"
                               placeholder="Enter quiz question" required>
                      </div>
                      <div class="options-grid">
                        <div *ngFor="let opt of quiz.options; let j = index" class="option-group">
                          <label>Option {{ j + 1 }}</label>
                          <input type="text"
                                 [(ngModel)]="oldCourse.quizzes[i].options[j]"
                                 [name]="'quiz_' + i + '_opt_' + j"
                                 placeholder="Enter option {{ j + 1 }}">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Correct Answer (0-3)</label>
                        <select [(ngModel)]="oldCourse.quizzes[i].correctAnswer"
                                [name]="'quiz_' + i + '_correct'">
                          <option [value]="0">Option A (0)</option>
                          <option [value]="1">Option B (1)</option>
                          <option [value]="2">Option C (2)</option>
                          <option [value]="3">Option D (3)</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn-submit" [disabled]="isSubmitting || loading">
            @if (loading || isSubmitting) {
              <span class="loading-spinner"></span>
              @if (mode === 'create') {
                Creating Course...
              } @else {
                Updating Course...
              }
            } @else {
              @if (mode === 'create') {
                <i class="icon-rocket"></i> Create Course
              } @else {
                <i class="icon-check"></i> Update Course
              }
            }
          </button>
          @if (mode === 'edit') {
            <button type="button" class="btn-secondary" (click)="resetForm()"
                    [disabled]="isSubmitting || loading">
              <i class="icon-cancel"></i> Cancel
            </button>
          }
        </div>
      </form>
    </div>
  </section>

  <!-- Courses List -->
  <section class="courses-list">
    <div class="section-header">
      <h2><i class="icon-courses"></i> My Courses</h2>
      <div class="courses-count">{{ courses.length }} course{{ courses.length !== 1 ? 's' : '' }}</div>
    </div>

    @if (loading && courses.length === 0) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading your courses...</p>
      </div>
    } @else if (courses.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üìö</div>
        <h3>No courses yet</h3>
        <p>Start by creating your first course above!</p>
      </div>
    } @else {
      <div class="course-grid">
        <div class="course-card" *ngFor="let course of courses">
          <div class="course-media">
            <img [src]="course.imageUrl || 'https://picsum.photos/300/180?random=1'"
                  [alt]="course.titre" loading="lazy">
            <div class="course-badges">
              <span class="badge badge-video" *ngIf="course.videoUrl">üé• Video</span>
              <span class="badge badge-quiz">üß† Quiz</span>
            </div>
            <div class="course-overlay">
              <button (click)="viewCourse(course.id!)" class="btn-overlay">
                <i class="icon-eye"></i> View Course
              </button>
            </div>
          </div>
          <div class="course-content">
            <div class="course-header">
              <h3>{{ course.titre }}</h3>
              <div class="course-status">
                <span class="status-dot status-active"></span>
                Active
              </div>
            </div>
            <p class="course-description">{{ course.description | slice:0:100 }}...</p>
            <div class="course-meta">
              <span class="meta-item">
                <i class="icon-calendar"></i>
                Created recently
              </span>
              <span class="meta-item">
                <i class="icon-users"></i>
                0 students
              </span>
            </div>
            <div class="course-actions">
              <button (click)="onEditCourse(course)" class="btn-action btn-edit"
                      title="Edit course">
                <i class="icon-edit"></i> Edit
              </button>
              <button (click)="onDeleteCourse(course.id!)" class="btn-action btn-delete"
                      title="Delete course">
                <i class="icon-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    }
  </section>
</div>

<!-- Add Quiz Modal -->
@if (showAddQuizModal) {
  <div class="modal-overlay" (click)="closeAddQuizModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Add New Quiz</h3>
        <button type="button" class="modal-close" (click)="closeAddQuizModal()">
          <i class="icon-close"></i>
        </button>
      </div>

      <form class="quiz-form" (ngSubmit)="saveQuiz()">
        <div class="form-group">
          <label for="quizQuestion">Question *</label>
          <input type="text" id="quizQuestion" [(ngModel)]="currentQuiz.question"
                 name="question" placeholder="Enter your quiz question" required>
        </div>

        <div class="options-section">
          <label>Options</label>
          <div class="options-list">
            <div class="option-input" *ngFor="let option of currentQuiz.options; let j = index">
              <input type="text" [(ngModel)]="currentQuiz.options[j]"
                     [name]="'option_' + j"
                     [placeholder]="'Option ' + (j + 1)"
                     required>
              <button type="button" class="btn-remove-option"
                      (click)="removeQuizOption(j)"
                      [disabled]="currentQuiz.options.length <= 2">
                <i class="icon-minus"></i>
              </button>
            </div>
          </div>
          <button type="button" class="btn-add-option" (click)="addQuizOption()">
            <i class="icon-plus"></i> Add Option
          </button>
        </div>

        <div class="form-group">
          <label for="correctAnswer">Correct Answer *</label>
          <select id="correctAnswer" [(ngModel)]="currentQuiz.correctAnswer" name="correctAnswer" required>
            <option [value]="j" *ngFor="let option of currentQuiz.options; let j = index">
              Option {{ j + 1 }}: {{ option || 'Option ' + (j + 1) }}
            </option>
          </select>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeAddQuizModal()">Cancel</button>
          <button type="submit" class="btn-primary" [disabled]="!isQuizValid()">
            Add Quiz
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- üèÅ Footer (identique au template) -->
<footer class="footer">
  <div class="footer-logo">
    <app-logo></app-logo>
    <span>EduLearn</span>
  </div>
  <p class="footer-subtitle">Virtual Class for Zoom</p>
  <p>Subscribe to get our Newsletter</p>
  <form class="newsletter-form">
    <input type="email" placeholder="Your Email" class="newsletter-input">
    <button type="submit" class="newsletter-btn">Subscribe</button>
  </form>
  <div class="footer-links">
    <a href="#">Careers</a>
    <a href="#">Privacy Policy</a>
    <a href="#">Terms & Conditions</a>
  </div>
  <p class="footer-copyright">¬© 2025 Class Technologies Inc.</p>
</footer>